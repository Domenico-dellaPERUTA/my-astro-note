---
import BarraPrincipale from "../components/BarraPrincipale.svelte";
import MenuLaterale from "../components/MenuLaterale.svelte";
import Annotazione from "../components/Annotazione.svelte";
import Layout from "../layouts/Layout.astro";
import { notesDb } from "../db/mysql";
import Messaggio from "../components/Messaggio.svelte";
import { isAdmin } from "../lib/auth";

// Carica le note dal database lato server
const notesData = await notesDb.getAll();
const userIsAdmin = isAdmin(Astro.cookies);
const role = userIsAdmin ? "admin" : "guest";

// Gestione deep linking
const urlId = Astro.url.searchParams.get("id");
---

<Layout>
  <section>
    <BarraPrincipale titolo="Appunti" userRole={role} client:load />
  </section>

  <div class="main-container">
    <aside class="sidebar">
      <MenuLaterale
        titolo="Lista Note"
        initialNotes={notesData}
        initialId={urlId}
        client:load
      />
    </aside>

    <main class="content-area">
      <Messaggio client:load />
      <Annotazione client:load />
    </main>
  </div>
</Layout>

<style is:global>
  .main-container {
    display: flex;
    height: calc(100vh - 60px);
    background-color: var(--bg-paper);
  }
  .sidebar {
    width: 25vw; /* Circa 1/4 dello schermo */
    min-width: 250px; /* Evita che diventi troppo stretta su schermi piccoli */
    background-color: var(--sidebar-bg);
    border-right: 1px solid #111;
    overflow-y: auto;
  }
  .content-area {
    position: relative;
    flex: 1;
    padding: 0;
    overflow-y: auto;
    /* Subtle texture overlay for main content */
    background-image: radial-gradient(#d0c9b6 2px, transparent 2px);
    background-size: 30px 30px;
  }
</style>
